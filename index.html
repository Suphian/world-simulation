<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Alternate World Civilization & Geopolitics Simulator — The Tesselated Sea (719 A.S.)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<div class="wrap" role="application" aria-label="Alternate World Civilization & Geopolitics Simulator">
  <header>
    <strong>Alternate World Civilization & Geopolitics Simulator</strong>
    <span class="small">Default: <em>The Tesselated Sea, Year 719 After the Sundering</em></span>
    <div class="inline" style="margin-left:auto">
      <button id="btnExportTxt" title="Download a readable .txt snapshot of world state">Export Text Report</button>
      <button id="btnSave" title="Download JSON save file">Save JSON</button>
      <label for="fileLoad" class="sr-only">Load JSON</label>
      <input id="fileLoad" type="file" accept="application/json" title="Load JSON save" />
    </div>
  </header>

  <!-- LEFT: Controls -->
  <aside class="controls" aria-label="Controls">
    <div class="panel-resize-handle" id="controlsResizeHandle"></div>
    <!-- Identity cards -->
    <div id="idCards" class="cards" aria-live="polite"></div>

    <fieldset>
      <legend>Simulation Controls</legend>
      <div class="row">
        <button id="btnRun" aria-label="Start or pause the simulation (Space)">▶️ Start</button>
        <button id="btnStep" aria-label="Advance one tick (N)">⏭️ Step</button>
        <label class="small">Speed (ms/tick)
          <input id="speed" type="range" min="16" max="1000" step="1" value="120" title="Increase: Slower simulation speed, easier to follow events, better for detailed observation. Decrease: Faster simulation, more rapid progression, but harder to track individual events.">
        </label>
        <span id="speedVal" class="badge">120</span>
      </div>
      <div class="row">
        <label>Randomness
          <input id="rngAmt" type="range" min="0" max="100" step="1" value="20" title="Increase: More unpredictable outcomes, varied battle results, dynamic trade fluctuations, less deterministic simulation. Decrease: More predictable results, consistent outcomes, easier to plan strategies, but less dynamic gameplay.">
        </label>
        <span id="rngVal" class="badge">20</span>
      </div>
      <div class="row">
        <label>Seed
          <input id="seed" type="text" value="719-SUNDER" aria-label="RNG seed for reproducible runs">
        </label>
        <button id="btnReseed" title="Apply RNG seed">Reseed</button>
      </div>
      <div class="row">
        <label for="preset">Preset</label>
        <select id="preset" title="Swap geography & starting values">
          <option value="tess">The Tesselated Sea (default)</option>
          <option value="we1914">Western Europe c.1914</option>
          <option value="bac1200">Bronze‑Age Collapse c.1200 BCE</option>
        </select>
        <button id="btnApplyPreset" title="Apply selected preset">Apply</button>
      </div>
      <div class="row">
        <label><input id="toggleProtector" type="checkbox"> Protector guarantees neutral if invaded</label>
      </div>
      <div class="row">
        <label>Ally joins when pressure ≥ <input id="allyPressure" type="number" min="0" max="100" step="5" value="65" style="width:60px" title="When a civ's external pressure exceeds this value, allies auto‑join its wars."></label>
      </div>
      <div class="row">
        <label><input id="testMode" type="checkbox"> TEST MODE (<span class="kbd">T</span>)</label>
        <button id="btnRunTest" title="Run deterministic verification sequence">Run Test Events</button>
      </div>
    </fieldset>

    <!-- Pillars & secondary sliders (bind to selected civ only; used in logic) -->
    <details class="collapse" open>
      <summary>Adjust Sliders — <strong id="selCivName">Select Civilization</strong></summary>
      <div class="row">
        <label for="selCiv">Civilization</label>
        <select id="selCiv" aria-label="Choose a civilization to edit"></select>
      </div>

      <!-- A) Religion & Culture -->
      <fieldset>
        <legend>A) Religion & Culture</legend>
        <div class="grid" title="↑ unity ⇒ cohesion; ↓ pluralism ⇒ less innovation at extremes.">
          <label for="religiousUnity">Religious Unity ↔ Pluralism</label>
          <input id="religiousUnity" type="range" min="0" max="100" step="1" title="Increase: Higher social cohesion, stronger cultural identity, better morale. Decrease: More religious diversity, increased innovation potential, but risk of social fragmentation."><span id="val_religiousUnity" class="badge">0</span>
        </div>
        <div class="grid" title="↑ trade/diplomacy/innovation; very low ⇒ unrest.">
          <label for="tolerance">Tolerance</label>
          <input id="tolerance" type="range" min="0" max="100" step="1" title="Increase: Better trade relations, diplomatic bonuses, innovation boost, cultural exchange. Decrease: Internal stability, cultural purity, but risk of unrest and isolation."><span id="val_tolerance" class="badge">0</span>
        </div>
        <div class="grid" title="↑ stability in tradition; high dampens innovation.">
          <label for="churchState">Church–State Integration</label>
          <input id="churchState" type="range" min="0" max="100" step="1" title="Increase: Higher stability, stronger social order, unified cultural direction. Decrease: Separation of powers, more secular governance, innovation freedom, but less social cohesion."><span id="val_churchState" class="badge">0</span>
        </div>
      </fieldset>

      <!-- B) Government & Institutions -->
      <fieldset>
        <legend>B) Government & Institutions</legend>
        <div class="grid" title="↑ mobilization/tax; too high ⇒ autonomy loss/unrest.">
          <label for="centralization">Centralization</label>
          <input id="centralization" type="range" min="0" max="100" step="1" title="Increase: Better resource mobilization, stronger military coordination, efficient governance. Decrease: Local autonomy, regional diversity, but weaker central authority and coordination."><span id="val_centralization" class="badge">0</span>
        </div>
        <div class="grid" title="↓ corruption; ↑ logistics & investment.">
          <label for="ruleOfLaw">Rule of Law / Integrity</label>
          <input id="ruleOfLaw" type="range" min="0" max="100" step="1" title="Increase: Reduced corruption, better logistics, increased investment, stable governance. Decrease: More flexible but potentially corrupt governance, faster decision-making, but less predictable outcomes."><span id="val_ruleOfLaw" class="badge">0</span>
        </div>
        <div class="grid" title="↑ treasury; very high depresses morale/economy.">
          <label for="taxCapacity">Tax Capacity</label>
          <input id="taxCapacity" type="range" min="0" max="100" step="1" title="Increase: Higher treasury income, more government resources, stronger state capacity. Decrease: Lower tax burden, better public morale, more private wealth, but less government funding."><span id="val_taxCapacity" class="badge">0</span>
        </div>
      </fieldset>

      <!-- C) Goods & Economy -->
      <fieldset>
        <legend>C) Goods & Economy</legend>
        <div class="grid" title="Base prosperity / pop support.">
          <label for="agri">Agricultural Surplus</label>
          <input id="agri" type="range" min="0" max="100" step="1" title="Increase: Higher base prosperity, better population support, food security, economic foundation. Decrease: Lower prosperity base, food insecurity, but more labor available for other sectors."><span id="val_agri" class="badge">0</span>
        </div>
        <div class="grid" title="Converts surplus into military/tech.">
          <label for="industry">Industrialization / Artisanal Output</label>
          <input id="industry" type="range" min="0" max="100" step="1" title="Increase: Better military equipment, technological advancement, economic diversification, wealth creation. Decrease: Simpler economy, less technological dependency, but reduced military and economic complexity."><span id="val_industry" class="badge">0</span>
        </div>
        <div class="grid" title="↑ growth/diffusion; ↑ exposure to blockades/shocks.">
          <label for="tradeOpen">Trade Openness</label>
          <input id="tradeOpen" type="range" min="0" max="100" step="1" title="Increase: Economic growth, cultural diffusion, wealth from trade, diplomatic connections. Decrease: Economic self-sufficiency, reduced vulnerability to trade disruptions, but isolation and slower growth."><span id="val_tradeOpen" class="badge">0</span>
        </div>
        <div class="grid" title="Metals/energy/exotics scaling industry/upkeep. (0–200)">
          <label for="resourceEndow">Resource Endowment (0–200)</label>
          <input id="resourceEndow" type="range" min="0" max="200" step="1" title="Increase: More valuable resources, higher economic potential, strategic importance, wealth generation. Decrease: Fewer resources, less economic complexity, but reduced resource dependency and conflict."><span id="val_resourceEndow" class="badge">0</span>
        </div>
      </fieldset>

      <!-- D) Writing, Literacy & Knowledge -->
      <fieldset>
        <legend>D) Writing, Literacy & Knowledge</legend>
        <div class="grid" title="↑ admin, logistics, research.">
          <label for="literacy">Literacy / Record‑Keeping</label>
          <input id="literacy" type="range" min="0" max="100" step="1" title="Increase: Better administration, improved logistics, research capabilities, cultural preservation. Decrease: Simpler governance, less bureaucratic overhead, but reduced knowledge accumulation and administrative efficiency."><span id="val_literacy" class="badge">0</span>
        </div>
        <div class="grid" title="Spreads knowledge; amplifies dissent risk.">
          <label for="media">Media / Printing Penetration</label>
          <input id="media" type="range" min="0" max="100" step="1" title="Increase: Knowledge diffusion, cultural exchange, public awareness, innovation spread. Decrease: Controlled information flow, reduced dissent risk, but slower knowledge sharing and cultural isolation."><span id="val_media" class="badge">0</span>
        </div>
        <div class="grid" title="↑ tech & arts; needs steady funding.">
          <label for="universities">Universities & Research</label>
          <input id="universities" type="range" min="0" max="100" step="1" title="Increase: Technological advancement, cultural development, innovation, knowledge generation. Decrease: Reduced research costs, simpler society, but slower technological and cultural progress."><span id="val_universities" class="badge">0</span>
        </div>
      </fieldset>

      <!-- E) Arts & Cultural Capital -->
      <fieldset>
        <legend>E) Arts & Cultural Capital</legend>
        <div class="grid" title="+ Soft power & morale; small treasury drain.">
          <label for="patronage">Patronage / Funding</label>
          <input id="patronage" type="range" min="0" max="100" step="1" title="Increase: Higher soft power, better morale, cultural development, diplomatic influence. Decrease: Reduced treasury drain, simpler governance, but less cultural influence and lower morale."><span id="val_patronage" class="badge">0</span>
        </div>
        <div class="grid" title="↑ diplomacy/trade desirability.">
          <label for="culturalPrestige">Cultural Prestige</label>
          <input id="culturalPrestige" type="range" min="0" max="100" step="1" title="Increase: Better diplomatic relations, increased trade desirability, cultural influence, soft power. Decrease: Reduced cultural complexity, simpler society, but less diplomatic and trade appeal."><span id="val_culturalPrestige" class="badge">0</span>
        </div>
      </fieldset>

      <!-- F) Social Structure -->
      <fieldset>
        <legend>F) Social Structure</legend>
        <div class="grid" title="Stability now; ↓ mobility/innovation later.">
          <label for="rigidity">Stratification Rigidity</label>
          <input id="rigidity" type="range" min="0" max="100" step="1" title="Increase: Social stability, clear hierarchies, predictable governance, reduced social unrest. Decrease: Social mobility, innovation potential, adaptability, but risk of social instability."><span id="val_rigidity" class="badge">0</span>
        </div>
        <div class="grid" title="↑ capital formation to a point; high ⇒ unrest spikes.">
          <label for="inequality">Inequality</label>
          <input id="inequality" type="range" min="0" max="100" step="1" title="Increase: Capital concentration, elite power, economic efficiency, but risk of unrest. Decrease: Social equality, reduced unrest risk, but potentially less economic efficiency and elite motivation."><span id="val_inequality" class="badge">0</span>
        </div>
        <div class="grid" title="Strong morale/resilience; extremal + high centralization may suppress diversity.">
          <label for="cohesion">Cohesion / Shared Identity</label>
          <input id="cohesion" type="range" min="0" max="100" step="1" title="Increase: Strong morale, social resilience, unified purpose, better crisis response. Decrease: Cultural diversity, innovation from different perspectives, but reduced social unity and morale."><span id="val_cohesion" class="badge">0</span>
        </div>
      </fieldset>

      <!-- Cross‑cutting -->
      <fieldset>
        <legend>Cross‑Cutting</legend>
        <div class="grid" title="Population in millions (1–200)">
          <label for="population">Population (M)</label>
          <input id="population" type="range" min="1" max="200" step="1" title="Increase: Larger workforce, more economic potential, greater military capacity, but higher resource demands. Decrease: Lower resource consumption, easier governance, but reduced economic and military potential."><span id="val_population" class="badge">0</span>
        </div>
        <div class="grid" title="Urbanization rate (0–100)">
          <label for="urban">Urbanization</label>
          <input id="urban" type="range" min="0" max="100" step="1" title="Increase: Economic efficiency, cultural centers, innovation hubs, but vulnerability to urban unrest. Decrease: Rural stability, food security, but reduced economic efficiency and cultural development."><span id="val_urban" class="badge">0</span>
        </div>
        <div class="grid" title="Infrastructure quality (0–100)">
          <label for="infra">Infrastructure</label>
          <input id="infra" type="range" min="0" max="100" step="1" title="Increase: Better logistics, economic efficiency, military mobility, trade capacity. Decrease: Lower maintenance costs, simpler society, but reduced efficiency and connectivity."><span id="val_infra" class="badge">0</span>
        </div>
        <div class="grid" title="Public Health (0–100)">
          <label for="health">Public Health</label>
          <input id="health" type="range" min="0" max="100" step="1" title="Increase: Better population health, higher productivity, reduced disease impact, longer lifespans. Decrease: Lower healthcare costs, simpler society, but reduced productivity and vulnerability to disease."><span id="val_health" class="badge">0</span>
        </div>
        <div class="grid" title="Military Strength (0–200)">
          <label for="military">Military Strength</label>
          <input id="military" type="range" min="0" max="200" step="1" title="Increase: Better overall military capability, territorial defense, offensive power, but higher maintenance costs. Decrease: Lower military costs, reduced threat perception, but vulnerability to attacks."><span id="val_military" class="badge">0</span>
        </div>
        <div class="grid" title="Aggression Level (0–100)">
          <label for="aggression">Aggression Level</label>
          <input id="aggression" type="range" min="0" max="100" step="1" title="Increase: More likely to declare war, expand aggressively, raid neighbors, but higher diplomatic penalties. Decrease: More peaceful, diplomatic approach, but may miss expansion opportunities."><span id="val_aggression" class="badge">0</span>
        </div>
        <div class="grid" title="Diplomatic Reputation (0–100)">
          <label for="diplomacy">Diplomatic Reputation</label>
          <input id="diplomacy" type="range" min="0" max="100" step="1" title="Increase: Better diplomatic relations, trade opportunities, alliance potential, reduced conflict risk. Decrease: Diplomatic isolation, reduced trade, but independence from foreign entanglements."><span id="val_diplomacy" class="badge">0</span>
        </div>
        <div class="grid" title="External pressure (raiders, storms, rivals)">
          <label for="pressure">External Pressure</label>
          <input id="pressure" type="range" min="0" max="100" step="1" title="Increase: Higher external threats, raider activity, diplomatic pressure, but increased defensive motivation. Decrease: Reduced external threats, peaceful environment, but potential complacency."><span id="val_pressure" class="badge">0</span>
        </div>
        <div class="grid" title="Random events intensity (0–100)">
          <label for="eventIntensity">Random Events Intensity</label>
          <input id="eventIntensity" type="range" min="0" max="100" step="1" title="Increase: More frequent random events, dynamic world, opportunities and challenges, but unpredictable outcomes. Decrease: More predictable simulation, stable conditions, but less dynamic gameplay."><span id="val_eventIntensity" class="badge">0</span>
        </div>
      </fieldset>
    </details>
  </aside>

  <!-- CENTER: Map -->
  <main aria-label="Map">
    <canvas id="map" tabindex="0" aria-label="World map (hex grid)"></canvas>
    <div id="toasts" aria-live="polite" aria-atomic="true"></div>
    <div id="tooltip" class="tooltip" style="display:none"></div>
    <div id="debugOverlay" class="overlay" hidden>
      <div><strong>TEST MODE</strong> — Diagnostics</div>
      <div id="diag"></div>
      <div class="small" style="margin-top:6px">
        Shortcuts: <span class="kbd">Space</span> Run/Pause · <span class="kbd">N</span> Step · <span class="kbd">T</span> Toggle Test Mode
      </div>
    </div>
  </main>

  <!-- RIGHT: HUD & News -->
  <section class="hud" aria-label="HUD">
    <div class="panel-resize-handle" id="hudResizeHandle"></div>
    <div class="legend">
      <div class="inline">
        <div class="swatch" style="background:#4FA3FF"></div> SAL
        <div class="swatch" style="background:#FF6E6E; margin-left:10px"></div> LYR
        <div class="swatch" style="background:#7AD37A; margin-left:10px"></div> THO
        <div class="swatch" style="background:#FFD166; margin-left:10px"></div> KHA
        <div class="swatch" style="background:#B66DFF; margin-left:10px"></div> GLA
      </div>
      <div class="small">Legend: Capitals (★), Resource hexes (two‑letter codes), Neutral (•), Outer Shoals (⚑), Blockade <span class="badge-blocked">blocked</span>.</div>
    </div>

    <div class="news" id="newsPanel">
      <div class="news-header">
        <h3>World Newsfeed</h3>
        <span class="resize-indicator">↕ Drag to resize</span>
      </div>
      <div id="newsText" class="news-content"></div>
      <div class="inline">
        <button id="btnCopyNews" title="Copy latest news summary to clipboard">Copy Summary</button>
      </div>
      <div class="resize-handle" id="newsResizeHandle"></div>
    </div>
  </section>

  <!-- FOOTER: Event Log & Scoreboard -->
  <footer aria-label="Event Log">
    <table aria-label="Civilization HUD" style="margin-bottom: 12px; width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #2a2a2a;">Civ</th>
          <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #2a2a2a;" title="Derived prosperity index">Prosperity</th>
          <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #2a2a2a;">Treasury</th>
          <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #2a2a2a;" title="Effective Military after industry, supply, morale">MilEff</th>
          <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #2a2a2a;" title="Aggression Level">Aggression</th>
          <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #2a2a2a;" title="Morale / Stability score">Morale</th>
          <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #2a2a2a;" title="Number of controlled hexes">Hexes</th>
          <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #2a2a2a;" title="At war?">War?</th>
          <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #2a2a2a;" title="Trade throughput last tick">Trade</th>
        </tr>
      </thead>
      <tbody id="hudRows"></tbody>
    </table>
    <div id="log" class="log"></div>
  </footer>
</div>
</body>
</html>
